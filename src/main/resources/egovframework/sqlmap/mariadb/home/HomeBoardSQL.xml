<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.home.pg.service.impl.PgHomeBoardMapper">

    <!-- 게시판 - 총 개수 -->
    <select id="getBoardTotalCnt" parameterType="hashMap" resultType="Double">
        SELECT COUNT(*)
        FROM BOARD
        <where>
            <if test='boardTypeId != null and boardTypeId != ""'>
                AND board_type_id = #{boardTypeId, jdbcType=CHAR}
            </if>
            <if test='searchQuery != null and searchQuery != ""'>
                AND title LIKE CONCAT('%', #{searchQuery, jdbcType=VARCHAR}, '%')
            </if>
        </where>
    </select>

    <!-- 게시판 - 리스트 -->
    <select id="getBoardList" parameterType="hashMap" resultType="egovMap">
        SELECT
        b.board_id,
        b.member_id,
        b.board_type_id,
        b.title,
        b.content,
        b.view_count,
        b.status,
        b.reg_dt,
        b.updt_dt,
        b.del_dt,
        m.name
        FROM BOARD b
        JOIN MEMBER m ON b.member_id = m.member_id
        <where>
            b.status = 'ACTIVE'
            <if test='searchBoardType != null and searchBoardType != ""'>
                AND b.board_type_id = #{searchBoardType, jdbcType=INTEGER}
            </if>
            <if test='searchQuery != null and searchQuery != ""'>
                AND b.title LIKE CONCAT('%', #{searchQuery, jdbcType=VARCHAR}, '%')
            </if>
        </where>
        ORDER BY b.board_type_id ASC, b.reg_dt DESC, b.title ASC
        LIMIT #{limitStart, jdbcType=INTEGER}, #{recordCnt, jdbcType=INTEGER}
    </select>

    <!-- 게시판 - 단일 조회 -->
    <select id="getBoard" parameterType="hashMap" resultType="egovMap">
        SELECT
        b.board_id,
        b.member_id,
        b.board_type_id,
        b.title,
        b.content,
        b.view_count,
        b.status,
        b.reg_dt,
        b.updt_dt,
        b.del_dt,
        m.name,
        bt.name AS board_type_name
        FROM BOARD b
        JOIN MEMBER m ON b.member_id = m.member_id
        JOIN BOARD_TYPE bt ON b.board_type_id = bt.board_type_id
        WHERE board_id = #{boardId, jdbcType=INTEGER}
    </select>

    <!-- 게시판 - Merge -->
    <insert id="setBoardMerge" parameterType="hashMap">
        INSERT INTO BOARD
        (
         <if test="boardId != null and boardId != ''">
             board_id,
         </if>
         member_id,
         board_type_id,
         title,
         content,
         reg_dt
        )
        VALUES
            (
             <if test="boardId != null and boardId != ''">
                 #{boardId, jdbcType=INTEGER},
             </if>
             #{memberId, jdbcType=INTEGER},
             #{boardTypeId, jdbcType=INTEGER},
             #{title, jdbcType=VARCHAR},
             #{content, jdbcType=VARCHAR},
             NOW()
            )
        ON DUPLICATE KEY UPDATE
            <if test="boardTypeId != null and boardTypeId != ''">
                board_type_id = #{boardTypeId, jdbcType=INTEGER},
            </if>
            <if test="title != null and title != ''">
                title = #{title, jdbcType=VARCHAR},
            </if>
            <if test="content != null and content != ''">
                content = #{content, jdbcType=VARCHAR},
            </if>
            <if test="status != null and status != ''">
                status = #{status, jdbcType=VARCHAR},
            </if>
            updt_dt = NOW()
    </insert>

    <!-- 게시판 - 상태 업데이트 ('ACTIVE', 'INACTIVE', 'DELETED') -->
    <update id="setBoardStatusUpdate" parameterType="hashMap">
        UPDATE BOARD
        SET status = #{status, jdbcType=VARCHAR},
            <if test="status == 'DELETED'">
                del_dt = NOW(),
            </if>
            updt_dt = NOW()
        WHERE board_id = #{boardId, jdbcType=INTEGER}
    </update>

    <!-- 게시판 - 조회수 + 1 -->
    <update id="increaseViewCount" parameterType="hashMap">
        UPDATE BOARD
        SET view_count = view_count + 1
        WHERE board_id = #{boardId, jdbcType=INTEGER}
    </update>

</mapper>
